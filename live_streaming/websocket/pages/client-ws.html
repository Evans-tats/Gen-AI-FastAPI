<!DOCTYPE html>
<html>
    <title>stream</title>
</html>
<body>
    <button id="stream_button">Start streaming</button>
    <button id="close_connection">close_connection</button>
    <label for="messageInput">ENTER YOUR PROMPT</label>
    <input type="text" id="messageInput" placeholder="Enter message">
    <div style="padding-top: 10px; color: #000;", id="container"></div>


    <script>
        const stream_button = document.getElementById("stream_button");
        const close_connection = document.getElementById("close_connection");
        const container = document.getElementById("container");
        const input = document.getElementById('messageInput');

        let ws;
        let retryCount = 0;
        let maxRetry = 5
        let isError = false

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function handleopen(){
            console.log("WebSocket connection opened");
            retryCount = 0;
            isError =false
        }
        function handMessage(event){
            container.textContent += event.data;
        }
        async function handleCLose() {
            console.log("websocket connection closed")
            if (isError && retryCount < maxRetry){
                console.warn("retrying connnections ........");
                console.warn(retryCount)
                await sleep(Math.pow(2,retryCount) * 1000);
                retryCount ++;
                connectWebSocket()
            } else if (isError) {
                console.warn("max retries reached. couldnt connect")
            }
        }
        function handleError(e){
            console.error("Websocket error :",e);
            isError = true;
            ws.close();
        }
        function connectWebSocket() {
            ws = new WebSocket("ws://localhost:8000/ws/chat");
            ws.onopen = handleopen;
            ws.onmessage = handMessage;
            ws.onclose = handleCLose;
            ws.onerror = handleError;
        }

        function resetForm(){
            input.value =""
            container.textContent = ""
        }

        stream_button.addEventListener('click', function() {
            const prompt = document.getElementById("messageInput").value
            if (prompt && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(prompt);
            }
            resetForm();
        });

        connectWebSocket();
    </script>
</body>